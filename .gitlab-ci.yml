stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  FRONTEND_IMAGE: bryanari/bloodlifesaver-frontend
  API_IMAGE: bryanari/bloodlifesaver-api

image: docker:24.0.7

before_script:
  - docker info

test_frontend:
  stage: test
  script:
    - cd frontend
    - docker run --rm -v $(pwd):/app -w /app node:20-alpine sh -c "npm install --legacy-peer-deps && npm run build"
  only:
    - main

test_api:
  stage: test
  script:
    - cd api
    - docker run --rm -v $(pwd):/app -w /app node:20-alpine sh -c "npm install --legacy-peer-deps && npm run build"
  only:
    - main

build:
  stage: build
  script:
    - echo $DOCKERHUB_PASSWORD | docker login -u bryanari --password-stdin
    - export VERSION=$(date +%Y%m%d-%H%M%S)
    
    - cd frontend
    - docker build -t $FRONTEND_IMAGE:$VERSION -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$VERSION
    - docker push $FRONTEND_IMAGE:latest
    
    - cd ../api
    - docker build -t $API_IMAGE:$VERSION -t $API_IMAGE:latest .
    - docker push $API_IMAGE:$VERSION
    - docker push $API_IMAGE:latest
    
    - echo $VERSION > ../version.txt
  artifacts:
    paths:
      - version.txt
    expire_in: 1 hour
  only:
    - main

deploy:
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ecdsa
    - chmod 600 ~/.ssh/id_ecdsa
    - ssh-add ~/.ssh/id_ecdsa
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  
  script:
    - export VERSION=$(cat version.txt)
    
    # Create deployment directory on server
    - ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p /home/mulindwabryan.aliddeki/bloodlifesaver"
    
    # Create .env file on server from CI/CD variables
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "cat > /home/mulindwabryan.aliddeki/bloodlifesaver/.env << EOF
      DATABASE_URL=$DATABASE_URL
      SUPABASE_URL=$SUPABASE_URL
      SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
      JWT_SECRET=$JWT_SECRET
      NEXT_PUBLIC_API_URL=http://ldapgit.cranecloud.io:31083
      NODE_ENV=production
      EOF"
    
    # Copy docker-compose file to server
    - scp docker-compose.prod.yml $DEPLOY_USER@$DEPLOY_HOST:/home/mulindwabryan.aliddeki/bloodlifesaver/
    
    # Login to DockerHub on server
    - ssh $DEPLOY_USER@$DEPLOY_HOST "echo '$DOCKERHUB_PASSWORD' | docker login -u bryanari --password-stdin"
    
    # Pull and deploy
    - ssh $DEPLOY_USER@$DEPLOY_HOST "docker pull $FRONTEND_IMAGE:latest"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "docker pull $API_IMAGE:latest"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /home/mulindwabryan.aliddeki/bloodlifesaver && docker-compose -f docker-compose.prod.yml down || true"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /home/mulindwabryan.aliddeki/bloodlifesaver && docker-compose -f docker-compose.prod.yml up -d"
    
    # Health check
    - sleep 10
    - ssh $DEPLOY_USER@$DEPLOY_HOST "docker ps | grep bloodlifesaver"
    
  only:
    - main