stages:
  - deploy

image: alpine:3.20

variables:
  # Your images are already fixed in docker-compose to :latest, so no tag juggling here
  FRONTEND_IMAGE: "bryanari/bloodlifesaver-frontend"
  API_IMAGE: "bryanari/bloodlifesaver-api"
  # Adjust these if your server paths differ
  DEPLOY_DIR: "/home/mulindwabryan.aliddeki/bloodlifesaver"
  COMPOSE_FILE: "docker-compose.prod.yml"

deploy_prod:
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    # Use the same key type you uploaded (ed25519 or ecdsa). Change the filename if needed.
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-add ~/.ssh/id_ed25519
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    # Ensure deployment dir exists
    - ssh "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p $DEPLOY_DIR"

    # Write/refresh .env on the server from GitLab CI/CD variables
    - |
      ssh "$DEPLOY_USER@$DEPLOY_HOST" "cat > $DEPLOY_DIR/.env << 'EOF'
      SUPABASE_DB_URL=$SUPABASE_DB_URL
      SUPABASE_URL=$SUPABASE_URL
      SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
      JWT_SECRET=$JWT_SECRET
      API_PORT=${API_PORT:-5000}
      NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://ldapgit.cranecloud.io:31083}
      NODE_ENV=production
      EOF"

    # Ship (or update) your compose file on the server â€” this is the exact file you shared
    - scp docker-compose.prod.yml "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_DIR/"

    # Login to DockerHub on the server (pull happens on the server)
    - ssh "$DEPLOY_USER@$DEPLOY_HOST" "echo '$DOCKERHUB_PASSWORD' | docker login -u bryanari --password-stdin"

    # Pull and (re)start using your compose file AS-IS (images pinned to :latest in the file)
    - |
      ssh "$DEPLOY_USER@$DEPLOY_HOST" "
        cd $DEPLOY_DIR &&
        docker-compose -f $COMPOSE_FILE pull &&
        docker-compose -f $COMPOSE_FILE up -d --remove-orphans
      "

    # Quick health checks (match your published ports)
    - |
      ssh "$DEPLOY_USER@$DEPLOY_HOST" "
        echo '--- docker ps ---'
        docker ps
        echo '--- health checks ---'
        (curl -fsS http://localhost:30083 || echo 'Frontend not ready yet')
        (curl -fsS http://localhost:31083/health || echo 'API not ready yet')
      "

  only:
    - main
