stages:
  - build
  - deploy

variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  FRONTEND_IMAGE: bryanari/bloodlifesaver-frontend
  API_IMAGE: bryanari/bloodlifesaver-api

image: docker:24.0.7

before_script:
  - docker info

build:
  stage: build
  script:
    # Login to DockerHub - use DOCKER_PASSWORD not DOCKERHUB_PASSWORD
    - echo $DOCKER_PASSWORD | docker login -u bryanari --password-stdin
    
    # Generate version tag
    - export VERSION=$(date +%Y%m%d-%H%M%S)
    
    # Build and push frontend
    - cd frontend
    - docker build --build-arg NEXT_PUBLIC_API_URL=http://ldapgit.cranecloud.io:31083 -t $FRONTEND_IMAGE:$VERSION -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$VERSION
    - docker push $FRONTEND_IMAGE:latest
    
    # Build and push API
    - cd ../api
    - docker build -t $API_IMAGE:$VERSION -t $API_IMAGE:latest .
    - docker push $API_IMAGE:$VERSION
    - docker push $API_IMAGE:latest
    
    # Save version for deploy stage
    - echo $VERSION > ../version.txt
    
  artifacts:
    paths:
      - version.txt
    expire_in: 1 hour
  only:
    - main
    
deploy:
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-add ~/.ssh/id_ed25519
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  
  script:
    - export VERSION=$(cat version.txt)
    
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p /home/mulindwabryan.aliddeki/bloodlifesaver"
    
    # Create .env file line by line
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SUPABASE_DB_URL=$SUPABASE_DB_URL' > /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SUPABASE_URL=$SUPABASE_URL' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'JWT_SECRET=$JWT_SECRET' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'API_PORT=$API_PORT' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'NEXT_PUBLIC_API_URL=http://ldapgit.cranecloud.io:31083' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo 'NODE_ENV=production' >> /home/mulindwabryan.aliddeki/bloodlifesaver/.env"
    
    - scp docker-compose.prod.yml "$DEPLOY_USER@$DEPLOY_HOST:/home/mulindwabryan.aliddeki/bloodlifesaver/"
    
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo '$DOCKER_PASSWORD' | docker login -u bryanari --password-stdin"
    
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "docker pull $FRONTEND_IMAGE:latest"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "docker pull $API_IMAGE:latest"
    
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "cd /home/mulindwabryan.aliddeki/bloodlifesaver && docker compose -f docker-compose.prod.yml down || true"
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "cd /home/mulindwabryan.aliddeki/bloodlifesaver && docker compose -f docker-compose.prod.yml up -d"
    
    - sleep 10
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "docker ps | grep bloodlifesaver"
    
  only:
    - main